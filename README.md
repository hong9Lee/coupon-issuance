# coupon-issuance
동시성 이슈 해결 관련 학습 - 쿠폰 발급

#### 요구사항 정의  
선착순 100명에게 할인쿠폰을 제공하는 이벤트를 진행한다.  

이 이벤트는 아래와 같은 조건을 만족해야 한다.  
- 선착순 100명에게만 지급되어야한다.
- 101개 이상이 지급되면 안된다.
- 순간적으로 몰리는 트래픽을 버틸 수 있어야 한다.

#### 문제점 및 해결방안
`동시성을 고려하지 않으면 동시에 여러 스레드에서 접근 했을 때, 레이스 컨디션이 발생하여 정상적인 쿠폰 발행이 불가능하다.`

싱글 스레드로 작업하게 된다면 레이스 컨디션은 발생하지 않게 되지만, 성능이 저하된다.  
가장 먼저 발급 시도한 유저의 쿠폰이 발급 완료 될때까지 다음 유저는 기다려야 하기 때문이다.  

synchronized를 사용하는 방식은 서버가 여러대가 된다면 레이스 컨디션이 동일하게 발생한다.  
또, lock을 걸게 된다면 쿠폰 갯수를 가져올때 부터 쿠폰 발급이 완료 될때까지 기다리는 시간이 길어지게 된다.  

#### `redis`  
redis는 싱글 스레드 기반으로 동작하며, incr 명령어는 key 값을 1씩 증가시키며 성능적으로도 이점이 있다.  

`문제점`
mysql에서 1분에 100개의 insert만 가능하다고 가정해보면,  

10:00 10000개의 쿠폰 생성 요청  
10:01 주문 생성 요청  
10:02 회원 가입 요청  

이러한 경우, 주문 요청과 회원가입 요청은 100분 이후에 가능하게 되며 일반적으로 타임아웃이 발생하게 된다.  
짧은 시간에 많은 요청이 들어오게되면 db 리소스를 많이 사용하게 되며, 서비스 지연 및 오류발생의 원인이 된다.  
<img width="1141" alt="쿠폰" src="https://github.com/hong9Lee/coupon-issuance/assets/94272140/92710e52-004e-4973-8e7b-c88acc925849">
